<!DOCTYPE html>
<html>
<head>

<title>Connect 4</title>

<script src="../jquery.js"></script>
<script src="../raphael/raphael.js"></script>

<style type="text/css">
body{
  width:641px;
  margin:0 auto;
}
h1, h1+p{
  margin:0;
}
</style>

</head>
<body>

<h1>Connect 4</h1>

<p>by <a href="http://github.com/laughinghan">Han</a>

<div id="paper"></div>

<script type="text/javascript">
(function(){
  var paper = Raphael('paper', 641, 641);

  //draw grid
  paper.rect(.5, 90.5, 640, 550)
  for(var i = 0; i < 7; i += 1)
    for(var j = 0; j < 6; j += 1)
      paper.circle(50.5 + i*90, 140.5 + j*90, 40);

  //global state
  var currentColor = 'red', board = [[], [], [], [], [], [], []], column,
    phantom = paper.circle(-40.5, 40.5, 40).attr({
      stroke: 'none',
      fill: currentColor
    });

  //event handlers
  $('#paper').mousemove(function(e){
    var col = ~~((e.offsetX-5)/90);
    if(col === 7) col = 6; //can't be past rightmost edge of the board

    column = board[col];

    //hide piece if column is full
    if(columnIsFull())
      hidePhantom();
    else
      phantom.attr('cx', 50.5 + col*90);
  })
  .mouseleave(hidePhantom)
  .click(function(){
    //ignore click if column is full
    if(columnIsFull())
      return;

    //drop distance, i.e. distance piece falls
    var drop = 5 - column.length;

    //add piece to column
    column.push(phantom.clone()
      .animate(
        {
          cy: 140.5 + drop*90
        },
        500 + drop*100,
        'bounce'
      )
    );

    //hide next piece if column is now full
    if(columnIsFull())
      hidePhantom();

    //swap color
    phantom.attr('fill', currentColor = swap[currentColor]);
  })
  .mousedown(false); //prevent annoying double-click-selects text thing

  //utils
  var swap = {red: 'yellow', yellow: 'red'};
  function columnIsFull(){
    return column.length === 6;
  }
  function hidePhantom(){
    phantom.attr('cx', -40.5);
  }
}());
</script>

</body>
</html>